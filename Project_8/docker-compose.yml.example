version: '3.8'

services:
  street-vision-api:
    # ✅ PRODUCTION: Image depuis Docker Hub
    image: grgmdmn/street-vision_api:latest
    
    container_name: street_vision_api
    
    ports:
      - "${NGINX_PORT:-8080}:${NGINX_PORT:-8080}"  # Port nginx configurable
    
    environment:
      # Configuration du port nginx
      NGINX_PORT: "${NGINX_PORT:-8080}"

      # Configuration MLflow pour le suivi des modèles
      MLFLOW_TRACKING_URI: "${MLFLOW_TRACKING_URI}"        # ex: https://mlflow.domain.com
      MLFLOW_S3_ENDPOINT_URL: "${MLFLOW_S3_ENDPOINT_URL}"  # ex: url MinIO ou S3
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"            # clé ID S3
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"    # clé secrète S3

      # Configuration email pour notifications (optionnel)
      SMTP_SERVER: "${SMTP_SERVER:-}"                      # serveur SMTP
      SMTP_PORT: "${SMTP_PORT:-587}"                       # port SMTP (ex: 587)
      SMTP_EMAIL: "${SMTP_EMAIL:-}"                        # email expéditeur
      SMTP_PASSWORD: "${SMTP_PASSWORD:-}"                  # mot de passe SMTP
      SMTP_FROM_ALIAS: "${SMTP_FROM_ALIAS:-Street Vision API}"  # alias (optionnel)
      ADMIN_EMAIL: "${ADMIN_EMAIL:-}"                      # email admin destinataire

      # URL de base de l'API (utilisée par Streamlit pour rediriger vers FastAPI)
      MULTISEG_API_BASE_URL: "${MULTISEG_API_BASE_URL}"    # ex: https://vision.domain.com/api

    # Pour une mise à jour automatique par watchtower
    labels:
      com.centurylinklabs.watchtower.enable: "true"

    # Seulement si vous avez un reverse proxy server
    # networks:
    #   - swag
    
    restart: unless-stopped

# Seulement si vous avez un reverse proxy server
# networks:
#   swag:
#     external: true
